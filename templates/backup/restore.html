{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_modify %}

{% block title %}{% trans "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞" %}{% endblock %}

{% block extrahead %}
{{ block.super }}
<style>
.progress-container {
    margin: 20px 0;
    padding: 20px;
    border: 1px solid #ddd;
    border-radius: 5px;
    background-color: #f9f9f9;
}

.progress-bar {
    width: 100%;
    height: 30px;
    background-color: #f0f0f0;
    border-radius: 15px;
    overflow: hidden;
    margin: 10px 0;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #4CAF50, #45a049);
    width: 0%;
    transition: width 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 14px;
}

.progress-fill.processing {
    background: linear-gradient(90deg, #2196F3, #1976D2);
}

.progress-fill.failed {
    background: linear-gradient(90deg, #f44336, #d32f2f);
}

.status-message {
    margin: 10px 0;
    padding: 10px;
    border-radius: 5px;
    font-weight: bold;
}

.status-pending {
    background-color: #fff3cd;
    border: 1px solid #ffeaa7;
    color: #856404;
}

.status-processing {
    background-color: #d1ecf1;
    border: 1px solid #bee5eb;
    color: #0c5460;
}

.status-completed {
    background-color: #d4edda;
    border: 1px solid #c3e6cb;
    color: #155724;
}

.status-failed {
    background-color: #f8d7da;
    border: 1px solid #f5c6cb;
    color: #721c24;
}

.import-stats {
    margin: 20px 0;
    padding: 15px;
    background-color: #e8f5e8;
    border-radius: 5px;
    border: 1px solid #c3e6cb;
}

.import-stats h4 {
    margin: 0 0 10px 0;
    color: #155724;
}

.import-stats ul {
    margin: 0;
    padding-left: 20px;
}

.import-stats li {
    margin: 5px 0;
}

.error-details {
    margin: 20px 0;
    padding: 15px;
    background-color: #f8d7da;
    border-radius: 5px;
    border: 1px solid #f5c6cb;
    color: #721c24;
    white-space: pre-wrap;
    font-family: monospace;
    font-size: 12px;
    max-height: 300px;
    overflow-y: auto;
}

.upload-area {
    border: 2px dashed #ccc;
    border-radius: 10px;
    padding: 40px;
    text-align: center;
    margin: 20px 0;
    background-color: #fafafa;
    transition: border-color 0.3s ease;
}

.upload-area.dragover {
    border-color: #4CAF50;
    background-color: #f0f8f0;
}

.upload-area input[type="file"] {
    display: none;
}

.upload-button {
    background-color: #4CAF50;
    color: white;
    padding: 12px 24px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
    margin: 10px;
}

.upload-button:hover {
    background-color: #45a049;
}

.upload-button:disabled {
    background-color: #ccc;
    cursor: not-allowed;
}

.recent-tasks {
    margin: 30px 0;
}

.recent-tasks h3 {
    color: #333;
    border-bottom: 2px solid #4CAF50;
    padding-bottom: 10px;
}

.task-item {
    padding: 15px;
    margin: 10px 0;
    border: 1px solid #ddd;
    border-radius: 5px;
    background-color: #f9f9f9;
}

.task-item.completed {
    border-color: #4CAF50;
    background-color: #f0f8f0;
}

.task-item.failed {
    border-color: #f44336;
    background-color: #fdf2f2;
}

.task-item.processing {
    border-color: #2196F3;
    background-color: #f0f8ff;
}
</style>
{% endblock %}

{% block content %}
<div class="progress-container">
    <h2>üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞</h2>
    
    <div class="upload-area" id="uploadArea">
        <p>üìÅ –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª –∞—Ä—Ö–∏–≤–∞ —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</p>
        <input type="file" id="fileInput" accept=".zip" />
        <button class="upload-button" id="uploadButton" onclick="document.getElementById('fileInput').click()">
            –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
        </button>
        <p><small>–û–∂–∏–¥–∞–µ—Ç—Å—è —Ñ–∞–π–ª –≤–∏–¥–∞ TDP_YYYYMMDD.zip, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –ø–∞–ø–∫–∏ data/ –∏ media/</small></p>
    </div>
    
    <div id="progressSection" style="display: none;">
        <div class="status-message" id="statusMessage"></div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill">0%</div>
        </div>
        <div id="importStats" class="import-stats" style="display: none;"></div>
        <div id="errorDetails" class="error-details" style="display: none;"></div>
    </div>
</div>

<div class="recent-tasks">
    <h3>üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–¥–∞—á–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è</h3>
    <div id="recentTasks">
        <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
    </div>
</div>

<script>
let currentTaskId = null;
let websocket = null;
let pollInterval = null;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', function() {
    loadRecentTasks();
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ drag & drop
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFile(files[0]);
        }
    });
    
    fileInput.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
            handleFile(e.target.files[0]);
        }
    });
});

function handleFile(file) {
    if (!file.name.startsWith('TDP_') || !file.name.endsWith('.zip')) {
        alert('–ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞. –û–∂–∏–¥–∞–µ—Ç—Å—è TDP_YYYYMMDD.zip');
        return;
    }
    
    const formData = new FormData();
    formData.append('archive', file);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
    document.getElementById('progressSection').style.display = 'block';
    document.getElementById('uploadButton').disabled = true;
    
    fetch('/admin/backup/backup/restore/', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.job_id) {
            currentTaskId = data.job_id;
            startProgressTracking();
        } else if (data.error) {
            showError(data.error);
        }
    })
    .catch(error => {
        showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞: ' + error.message);
    });
}

function startProgressTracking() {
    if (!currentTaskId) return;
    
    // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ WebSocket
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws/restore/${currentTaskId}/`;
    
    websocket = new WebSocket(wsUrl);
    
    websocket.onopen = function() {
        console.log('WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
    };
    
    websocket.onmessage = function(event) {
        const data = JSON.parse(event.data);
        updateProgress(data);
    };
    
    websocket.onclose = function() {
        console.log('WebSocket –æ—Ç–∫–ª—é—á–µ–Ω');
        // Fallback –Ω–∞ polling
        startPolling();
    };
    
    websocket.onerror = function(error) {
        console.error('WebSocket –æ—à–∏–±–∫–∞:', error);
        // Fallback –Ω–∞ polling
        startPolling();
    };
}

function startPolling() {
    if (pollInterval) clearInterval(pollInterval);
    
    pollInterval = setInterval(() => {
        if (!currentTaskId) return;
        
        fetch(`/admin/backup/backup/restore/status/${currentTaskId}/`)
        .then(response => response.json())
        .then(data => {
            updateProgress(data);
            
            if (data.status === 'completed' || data.status === 'failed') {
                clearInterval(pollInterval);
                pollInterval = null;
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞:', error);
        });
    }, 2000);
}

function updateProgress(data) {
    const progressFill = document.getElementById('progressFill');
    const statusMessage = document.getElementById('statusMessage');
    const importStats = document.getElementById('importStats');
    const errorDetails = document.getElementById('errorDetails');
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
    progressFill.style.width = data.progress + '%';
    progressFill.textContent = data.progress + '%';
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞—Å—Å –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
    progressFill.className = 'progress-fill';
    if (data.status === 'processing') {
        progressFill.classList.add('processing');
    } else if (data.status === 'failed') {
        progressFill.classList.add('failed');
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    statusMessage.textContent = data.message;
    statusMessage.className = 'status-message status-' + data.status;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏–º–ø–æ—Ä—Ç–∞
    if (data.status === 'completed' && data.imported) {
        importStats.style.display = 'block';
        importStats.innerHTML = `
            <h4>‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!</h4>
            <ul>
                <li>üìÇ –ö–∞—Ç–µ–≥–æ—Ä–∏–∏: ${data.imported.categories}</li>
                <li>üè∑Ô∏è –¢–µ–≥–∏: ${data.imported.tags}</li>
                <li>üèñÔ∏è –¢—É—Ä—ã: ${data.imported.tours}</li>
                <li>üõ†Ô∏è –£—Å–ª—É–≥–∏: ${data.imported.services}</li>
                <li>‚≠ê –û—Ç–∑—ã–≤—ã: ${data.imported.reviews}</li>
                <li>üì∞ –ù–æ–≤–æ—Å—Ç–∏: ${data.imported.news}</li>
                <li>üìù –°—Ç–∞—Ç—å–∏: ${data.imported.blog}</li>
                <li>üí∞ –ü—Ä–∞–π—Å—ã: ${data.imported.prices}</li>
                <li>üìÅ –§–∞–π–ª—ã: ${data.imported.files}</li>
            </ul>
        `;
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫–∏
    if (data.status === 'failed' && data.error) {
        errorDetails.style.display = 'block';
        errorDetails.textContent = data.error;
    }
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
    if (data.status === 'completed' || data.status === 'failed') {
        document.getElementById('uploadButton').disabled = false;
        document.getElementById('fileInput').value = '';
        loadRecentTasks();
    }
}

function showError(message) {
    const statusMessage = document.getElementById('statusMessage');
    statusMessage.textContent = message;
    statusMessage.className = 'status-message status-failed';
    document.getElementById('uploadButton').disabled = false;
}

function loadRecentTasks() {
    fetch('/admin/backup/backup/restore/tasks/')
    .then(response => response.json())
    .then(data => {
        const container = document.getElementById('recentTasks');
        
        if (data.tasks && data.tasks.length > 0) {
            container.innerHTML = data.tasks.map(task => `
                <div class="task-item ${task.status}">
                    <strong>${task.filename}</strong> 
                    <span class="status-${task.status}">${getStatusText(task.status)}</span>
                    <br>
                    <small>${task.message}</small>
                    <br>
                    <small>–°–æ–∑–¥–∞–Ω–æ: ${new Date(task.created_at).toLocaleString()}</small>
                </div>
            `).join('');
        } else {
            container.innerHTML = '<p>–ù–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è</p>';
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞–¥–∞—á:', error);
        document.getElementById('recentTasks').innerHTML = '<p>–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞–¥–∞—á</p>';
    });
}

function getStatusText(status) {
    const statusTexts = {
        'pending': '‚è≥ –û–∂–∏–¥–∞–µ—Ç',
        'processing': 'üîÑ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è',
        'completed': '‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ',
        'failed': '‚ùå –û—à–∏–±–∫–∞',
        'cancelled': 'üö´ –û—Ç–º–µ–Ω–µ–Ω–æ'
    };
    return statusTexts[status] || status;
}
</script>
{% endblock %}
