{% extends "base.html" %}
{% load static humanize %}

{% block title %}Прайс — Экскурсии и Услуги{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'styles/tours.css' %}">
  <link rel="stylesheet" href="{% static 'styles/slide.css' %}">
  <link rel="stylesheet" href="{% static 'styles/prices.css' %}">
{% endblock %}

{% block body_class %}has-inner-hero{% endblock %}

{% block after_header %}<div class="header-spacer" aria-hidden="true"></div>{% endblock %}

{% block content %}

<section class="home slide slide--inner">
  <div class="home_slider_container">
    <div class="background_image" style="background-image:url({% static 'images/home_slider.jpg' %})"></div>
    <div class="home_slider_content_container">
      <div class="hero hero--inner">
        <div class="container hero__grid">
          <div class="hero-left">
            <h1 class="hero-title">Прайс</h1>
            <p class="hero-sub">Актуальные основные цены на экскурсии и услуги.</p>
          </div>
          <div class="hero-right"></div>
        </div>
      </div>
    </div>
  </div>
</section>

<div class="container my-4">
  <div class="row">
    <div class="col-lg-8 col-xl-9">
      {% if price_pdf %}
        <div class="mb-4">
          <div class="alert alert-secondary d-flex align-items-center" role="alert">
            <div class="me-3">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 3v10" stroke="#333" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M8 11l4 4 4-4" stroke="#333" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </div>
            <div>
              <div><strong>Скачать актуальный прайс (PDF)</strong></div>
              <div class="small text-muted">{{ price_pdf.name }} — загружено {{ price_pdf.uploaded_at|date:'d.m.Y H:i' }}</div>
            </div>
            <div class="ms-auto">
              <a href="{{ price_pdf.file.url }}" class="btn btn-primary" download>Скачать PDF</a>
            </div>
          </div>
        </div>
      {% endif %}
      <!-- Экскурсии -->
      <div class="price-section mb-5">
        <div class="price-section__header">
          <h2 class="price-section__title">
            <i class="fa fa-map-marker"></i>
            Экскурсии
          </h2>
          <div class="price-section__count">{{ tours|length }} экскурсий</div>
        </div>
        
        {% if tours %}
          <div class="price-table-container">
            <table class="price-table">
              <thead>
                <tr>
                  <th class="price-table__name">Название экскурсии</th>
                  <th class="price-table__location">Локация</th>
                  <th class="price-table__duration">Длительность</th>
                  <th class="price-table__price">Цена (взрослый)</th>
                  <th class="price-table__price">Цена (детский)</th>
                  <th class="price-table__actions">Действия</th>
                </tr>
              </thead>
              <tbody>
                {% for t in tours %}
                  <tr class="price-table__row">
                    <td class="price-table__name">
                      <div class="price-item">
                        {% if t.cover %}
                          <img src="{{ t.cover.url }}" alt="{{ t.title }}" class="price-item__image">
                        {% endif %}
                        <div class="price-item__content">
                          <a href="{{ t.get_absolute_url }}" class="price-item__title">{{ t.title }}</a>
                          {% if t.short_desc %}
                            <div class="price-item__desc">{{ t.short_desc|truncatechars:80 }}</div>
                          {% endif %}
                        </div>
                      </div>
                    </td>
                    <td class="price-table__location" data-label="Локация">
                      {% if t.location %}
                        <span class="price-location">
                          <i class="fa fa-map-marker"></i>
                          {{ t.location }}
                        </span>
                      {% else %}
                        <span class="text-muted">—</span>
                      {% endif %}
                    </td>
                    <td class="price-table__duration" data-label="Длительность">
                      {% if t.duration %}
                        <span class="price-duration">
                          <i class="fa fa-clock-o"></i>
                          {{ t.duration }}
                        </span>
                      {% else %}
                        <span class="text-muted">—</span>
                      {% endif %}
                    </td>
                    <td class="price-table__price" data-label="Цена (взрослый)">
                      <div class="price-value">
                        {% if t.price_old_adult and t.price_old_adult > t.price_adult %}
                          <div class="price-old">{{ t.price_old_adult|floatformat:0|intcomma }}฿</div>
                        {% endif %}
                        <div class="price-current">{{ t.price_adult|floatformat:0|intcomma }}฿</div>
                      </div>
                    </td>
                    <td class="price-table__price" data-label="Цена (детский)">
                      {% if t.price_child %}
                        <div class="price-value">
                          {% if t.price_old_child and t.price_old_child > t.price_child %}
                            <div class="price-old">{{ t.price_old_child|floatformat:0|intcomma }}฿</div>
                          {% endif %}
                          <div class="price-current">{{ t.price_child|floatformat:0|intcomma }}฿</div>
                        </div>
                      {% else %}
                        <span class="text-muted">—</span>
                      {% endif %}
                    </td>
                    <td class="price-table__actions" data-label="Действия">
                      <div class="price-actions">
                        <a href="{{ t.get_absolute_url }}" class="btn btn-sm btn-outline-primary">
                          <i class="fa fa-eye"></i> Подробнее
                        </a>
                        <button class="btn btn-sm btn-primary open-lead-modal"
                                data-cta="Prices — {{ t.title }}"
                                data-related_type="tour" 
                                data-related_id="{{ t.id }}">
                          <i class="fa fa-calendar"></i> Заказать
                        </button>
                      </div>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="price-empty">
            <i class="fa fa-map-marker"></i>
            <h3>Пока нет экскурсий</h3>
            <p>Скоро здесь появятся интересные экскурсии по Пхукету!</p>
          </div>
        {% endif %}
      </div>

      <!-- Услуги -->
      <div class="price-section">
        <div class="price-section__header">
          <h2 class="price-section__title">
            <i class="fa fa-cogs"></i>
            Услуги
          </h2>
          <div class="price-section__count">{{ services|length }} услуг</div>
        </div>
        
        {% if services %}
          <div class="price-table-container">
            <table class="price-table">
              <thead>
                <tr>
                  <th class="price-table__name">Название услуги</th>
                  <th class="price-table__location">Локация</th>
                  <th class="price-table__price">Основная цена</th>
                  <th class="price-table__price">Дополнительно</th>
                  <th class="price-table__actions">Действия</th>
                </tr>
              </thead>
              <tbody>
                {% for s in services %}
                  <tr class="price-table__row">
                    <td class="price-table__name">
                      <div class="price-item">
                        {% if s.cover %}
                          <img src="{{ s.cover.url }}" alt="{{ s.title }}" class="price-item__image">
                        {% endif %}
                        <div class="price-item__content">
                          <a href="{{ s.get_absolute_url }}" class="price-item__title">{{ s.title }}</a>
                          {% if s.short_desc %}
                            <div class="price-item__desc">{{ s.short_desc|truncatechars:80 }}</div>
                          {% endif %}
                        </div>
                      </div>
                    </td>
                    <td class="price-table__location" data-label="Локация">
                      {% if s.location %}
                        <span class="price-location">
                          <i class="fa fa-map-marker"></i>
                          {{ s.location }}
                        </span>
                      {% else %}
                        <span class="text-muted">—</span>
                      {% endif %}
                    </td>
                    <td class="price-table__price" data-label="Основная цена">
                      <div class="price-value">
                        {% if s.price_old_adult and s.price_old_adult > s.price_adult %}
                          <div class="price-old">{{ s.price_old_adult|floatformat:0|intcomma }}฿</div>
                        {% endif %}
                        <div class="price-current">{{ s.price_adult|floatformat:0|intcomma }}฿</div>
                      </div>
                    </td>
                    <td class="price-table__price" data-label="Дополнительно">
                      {% if s.price_child or s.price_extra %}
                        <div class="price-value">
                          {% if s.price_child %}
                            <div class="price-current">{{ s.price_child|floatformat:0|intcomma }}฿</div>
                          {% elif s.price_extra %}
                            <div class="price-current">{{ s.price_extra|floatformat:0|intcomma }}฿</div>
                          {% endif %}
                        </div>
                      {% else %}
                        <span class="text-muted">—</span>
                      {% endif %}
                    </td>
                    <td class="price-table__actions" data-label="Действия">
                      <div class="price-actions">
                        <a href="{{ s.get_absolute_url }}" class="btn btn-sm btn-outline-primary">
                          <i class="fa fa-eye"></i> Подробнее
                        </a>
                        <button class="btn btn-sm btn-primary open-lead-modal"
                                data-cta="Prices — {{ s.title }}"
                                data-related_type="service" 
                                data-related_id="{{ s.id }}">
                          <i class="fa fa-calendar"></i> Заказать
                        </button>
                      </div>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="price-empty">
            <i class="fa fa-cogs"></i>
            <h3>Пока нет услуг</h3>
            <p>Скоро здесь появятся полезные услуги для туристов!</p>
          </div>
        {% endif %}
      </div>
    </div>

    <aside class="col-lg-4 col-xl-3 t-aside">
      {% if categories_tours %}
        <div class="t-aside__box">
          <div class="t-aside__title">Категории — Экскурсии</div>
          <ul class="t-aside__list">
            {% for c in categories_tours %}
              <li><a href="{% url 'tours:by_category' slug=c.slug %}">{{ c.name }}{% if c.items %} <span class="text-muted">({{ c.items }})</span>{% endif %}</a></li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}

      {% if categories_services %}
        <div class="t-aside__box">
          <div class="t-aside__title">Категории — Услуги</div>
          <ul class="t-aside__list">
            {% for c in categories_services %}
              <li><a href="{% url 'services:by_category' slug=c.slug %}">{{ c.name }}{% if c.items %} <span class="text-muted">({{ c.items }})</span>{% endif %}</a></li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}

      {% if popular_tours %}
        <div class="t-aside__box">
          <div class="t-aside__title">Популярные — Экскурсии</div>
          <ul class="t-aside__popular">
            {% for p in popular_tours %}
              <li>
                <a href="{{ p.get_absolute_url }}">{% if p.cover %}<img src="{{ p.cover.url }}" alt="{{ p.title }}">{% endif %} {{ p.title }}</a>
                <div class="small text-muted">{{ p.price_adult|floatformat:0 }}</div>
              </li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}

      {% if popular_services %}
        <div class="t-aside__box">
          <div class="t-aside__title">Популярные — Услуги</div>
          <ul class="t-aside__popular">
            {% for p in popular_services %}
              <li>
                <a href="{{ p.get_absolute_url }}">{% if p.cover %}<img src="{{ p.cover.url }}" alt="{{ p.title }}">{% endif %} {{ p.title }}</a>
                <div class="small text-muted">{{ p.price_adult|floatformat:0 }}</div>
              </li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}

      {% if tags %}
        <div class="t-aside__box">
          <div class="t-aside__title">Теги</div>
          <div class="t-aside__tags">
            {% for tg in tags %}
              <a href="{% url 'tours:by_tag' slug=tg.slug %}">#{{ tg.name }}</a>
            {% endfor %}
          </div>
        </div>
      {% endif %}
    </aside>
  </div>
</div>

{% endblock %}
