{% extends "base.html" %}
{% load static humanize %}

{% block title %}
  {% if active_category %}Экскурсии: {{ active_category.name }} — {% elif active_tag %}Экскурсии по тегу: #{{ active_tag.name }} — {% endif %}Экскурсии на Пхукете
{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'styles/tours.css' %}">
  <link rel="stylesheet" href="{% static 'styles/slide.css' %}">
  <link rel="stylesheet" href="{% static 'styles/tour-sticky-cta.css' %}">
{% endblock %}

{% block body_class %}has-inner-hero{% endblock %}

{% block content %}

{# ===== SLIDE-HERO (inline) ===== #}
<section class="home slide slide--inner">
  <div class="home_slider_container">
    <div class="background_image"
         style="background-image:url({% static 'images/home_slider.jpg' %})"></div>

    <div class="home_slider_content_container">
      <div class="hero hero--inner">
        <div class="container hero__grid">
          <div class="hero-left">
            <h1 class="hero-title">
              {% if active_category %}Экскурсии: {{ active_category.name }}
              {% elif active_tag %}Экскурсии по тегу: #{{ active_tag.name }}
              {% else %}Экскурсии на Пхукете{% endif %}
            </h1>
            <p class="hero-sub">
              Подберите идеальную экскурсию для незабываемого отдыха на Пхукете.
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Блок категорий с автопрокруткой -->
<section class="tour-categories-slider">
  <div class="container">
    <div class="categories-slider-wrapper">
      <div class="categories-slider" id="categoriesSlider">
        {% for category in categories %}
          <a href="{% url 'tours:by_category' category.slug %}" class="category-item">
            <span class="category-name">{{ category.name }}</span>
            <span class="category-count">({{ category.items }})</span>
          </a>
        {% endfor %}
        <!-- Дублируем категории для бесконечной прокрутки -->
        {% for category in categories %}
          <a href="{% url 'tours:by_category' category.slug %}" class="category-item">
            <span class="category-name">{{ category.name }}</span>
            <span class="category-count">({{ category.items }})</span>
          </a>
        {% endfor %}
        <!-- Третья копия для более плавного кольца -->
        {% for category in categories %}
          <a href="{% url 'tours:by_category' category.slug %}" class="category-item">
            <span class="category-name">{{ category.name }}</span>
            <span class="category-count">({{ category.items }})</span>
          </a>
        {% endfor %}
      </div>
    </div>
  </div>
</section>

  {# ===== КОМПАКТНЫЕ ФИЛЬТРЫ ===== #}
  <section class="compact-filters">
    <div class="container">
      <form class="compact-filters__form" method="get" action="{% url 'tours:list' %}">
        
        <!-- Основная строка: Фильтры/Поиск + Кнопки -->
        <div class="compact-filters__main">
          <div class="compact-filters__toggle" id="filtersToggle">
            <span class="toggle-text" id="toggleText">Фильтры</span>
            <i class="fa fa-chevron-down toggle-icon" id="toggleIcon"></i>
          </div>
          
          <!-- Поле поиска (скрыто по умолчанию) -->
          <input type="search" 
                 name="q" 
                 value="{{ request.GET.q }}" 
                 placeholder="Поиск по названию, месту, описанию"
                 class="compact-filters__search-input"
                 id="searchInput"
                 style="display: none;">
          
          <!-- Кнопка выполнения поиска (скрыта по умолчанию) -->
          <button type="submit" class="compact-filters__submit-search" id="submitSearchBtn" style="display: none;">
            <i class="fa fa-search"></i>
          </button>
          
          <!-- Кнопка переключения поиска -->
          <button type="button" class="compact-filters__search-btn" id="searchToggle">
            <i class="fa fa-search"></i>
          </button>
        </div>

        <!-- Выдвижная панель фильтров -->
        <div class="compact-filters__panel" id="filtersPanel">
          <div class="compact-filters__row">
            <div class="compact-filters__price">
            <label>Цена, ฿</label>
              <div class="price-inputs">
            <input type="number" name="price_min" value="{{ request.GET.price_min }}" min="0" placeholder="от">
            <span>—</span>
            <input type="number" name="price_max" value="{{ request.GET.price_max }}" min="0" placeholder="до">
          </div>
            </div>
            <div class="compact-filters__sort">
            <label>Сортировка</label>
            <select name="sort" onchange="this.form.submit()">
              <option value="" {% if not request.GET.sort %}selected{% endif %}>По популярности</option>
              <option value="price_asc"  {% if request.GET.sort == 'price_asc' %}selected{% endif %}>Цена ↑</option>
              <option value="price_desc" {% if request.GET.sort == 'price_desc' %}selected{% endif %}>Цена ↓</option>
              <option value="newest"     {% if request.GET.sort == 'newest' %}selected{% endif %}>Сначала новые</option>
            </select>
          </div>
            <div class="compact-filters__submit">
              <button class="apply-btn" type="submit">Применить</button>
            </div>
          </div>
        </div>

      </form>
    </div>
  </section>

  {# ===== КОНТЕНТ ===== #}
  <section class="t-grid">
    <div class="container">
      <div class="row">

        <div class="col-lg-8 col-xl-9">
          <div class="row g-3">
            {% for t in tours %}
              <div class="col-12 col-sm-6 col-xl-4 d-flex">
                <article class="t-card h-100" style="cursor:pointer;" onclick="location.href='{{ t.get_absolute_url }}'">
                  <div class="t-card__cover">
                    {% if t.cover %}
                      <img class="t-card__img" src="{{ t.cover.url }}" alt="{{ t.title }}" loading="lazy">
                    {% else %}
                      <img class="t-card__img" src="{% static 'images/travello.jpg' %}" alt="{{ t.title }}" loading="lazy">
                    {% endif %}
                    {% if t.has_discount %}<span class="badge badge--disc">Скидка</span>{% endif %}
                    {% if t.is_popular %}<span class="badge badge--hit">Хит</span>{% endif %}
                  </div>

                  <div class="t-card__body">
                    <div class="t-card__header">
                      <h3 class="t-card__title">{{ t.title }}</h3>
                      <div class="t-card__meta">
                        {% if t.duration %}<span class="t-meta-item"><i class="fa fa-clock-o"></i> {{ t.duration }}</span>{% endif %}
                        {% if t.location %}<span class="t-meta-item"><i class="fa fa-map-marker"></i> {{ t.location }}</span>{% endif %}
                      </div>
                    </div>

                    <div class="t-card__price-section">
                      <div class="t-card__price-main">
                        <div class="t-price-group">
                          <span class="t-price-label">Взрослые</span>
                          <div class="t-price">
                            {% if t.price_old_adult and t.price_old_adult > t.price_adult %}
                              <s class="t-price__old">{{ t.price_old_adult|floatformat:0|intcomma }}฿</s>
                            {% endif %}
                            <strong class="t-price__new">{{ t.price_adult|floatformat:0|intcomma }}฿</strong>
                          </div>
                        </div>
                        {% if t.price_child %}
                        <div class="t-price-group">
                          <span class="t-price-label">Дети</span>
                          <div class="t-price">
                            {% if t.price_old_child and t.price_old_child > t.price_child %}
                              <s class="t-price__old">{{ t.price_old_child|floatformat:0|intcomma }}฿</s>
                            {% endif %}
                            <strong class="t-price__new">{{ t.price_child|floatformat:0|intcomma }}฿</strong>
                          </div>
                        </div>
                        {% endif %}
                      </div>
                      {% if t.price_extra %}
                      <div class="t-card__price-extra">
                        <span class="t-price-label">Дополнительные услуги</span>
                        <div class="t-price">
                          <strong class="t-price__new">{{ t.price_extra|floatformat:0|intcomma }}฿</strong>
                        </div>
                      </div>
                      {% endif %}
                    </div>

                    <div class="t-card__footer">
                      <div class="t-rating">
                        <i class="fa fa-star"></i>
                        <span class="t-rating-value">{{ t.rating|default:"4.9" }}</span>
                        {% if t.reviews_count %}<span class="t-reviews-count">({{ t.reviews_count }})</span>{% endif %}
                      </div>
                      <button class="order_btn open-lead-modal"
                              data-cta="Tours — {{ t.title }}"
                              data-related_type="tour"
                              data-related_id="{{ t.id }}">Заказать</button>
                    </div>
                  </div>
                </article>
              </div>
            {% empty %}
              <div class="col-12">
                <p class="text-center text-muted my-5">По заданным фильтрам ничего не найдено.</p>
              </div>
            {% endfor %}
          </div>

          {% if page_obj and page_obj.paginator.num_pages > 1 %}
            <nav class="t-pagination" aria-label="Навигация по страницам">
              <ul class="pagination justify-content-center">
                {% if page_obj.has_previous %}
                  <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}">« Назад</a>
                  </li>
                {% endif %}
                <li class="page-item disabled">
                  <span class="page-link">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
                </li>
                {% if page_obj.has_next %}
                  <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}">Вперёд »</a>
                  </li>
                {% endif %}
              </ul>
            </nav>
          {% endif %}
        </div>

        <aside class="col-lg-4 col-xl-3 t-aside">
          {% if categories %}
            <div class="t-aside__box">
              <div class="t-aside__title">Категории</div>
              <ul class="t-aside__list">
                {% for c in categories %}
                  <li>
                    <a href="{% url 'tours:by_category' slug=c.slug %}">{{ c.name }}</a>
                    {% if c.items %}<span>{{ c.items }}</span>{% endif %}
                  </li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}

          {% if tags %}
            <div class="t-aside__box">
              <div class="t-aside__title">Теги</div>
              <div class="t-aside__tags">
                {% for tg in tags %}
                  <a href="{% url 'tours:by_tag' slug=tg.slug %}">#{{ tg.name }}</a>
                {% endfor %}
              </div>
            </div>
          {% endif %}

          {% if popular_tours %}
            <div class="t-aside__box">
              <div class="t-aside__title">Популярные</div>
              <ul class="t-aside__popular">
                {% for p in popular_tours %}
                  <li>
                    <a href="{{ p.get_absolute_url }}">
                      {% if p.cover %}
                        <img src="{{ p.cover.url }}" alt="{{ p.title }}" loading="lazy">
                      {% endif %}
                      <span class="t">
                        {% if p.title|length > 38 %}{{ p.title|slice:":38" }}…{% else %}{{ p.title }}{% endif %}
                      </span>
                      <span class="pr">{{ p.price_adult|floatformat:0|intcomma }}฿</span>
                    </a>
                  </li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}
        </aside>

      </div>
    </div>
  </section>

{% endblock %}

{% block extra_js %}
  <script>
    // Управление компактными фильтрами
    (function() {
      console.log('Инициализация компактных фильтров...');
      
      var filtersToggle = document.getElementById('filtersToggle');
      var filtersPanel = document.getElementById('filtersPanel');
      var searchToggle = document.getElementById('searchToggle');
      var searchInput = document.getElementById('searchInput');
      var toggleText = document.getElementById('toggleText');
      var toggleIcon = document.getElementById('toggleIcon');
      var submitSearchBtn = document.getElementById('submitSearchBtn');
      
      console.log('Элементы найдены:', {
        filtersToggle: !!filtersToggle,
        filtersPanel: !!filtersPanel,
        searchToggle: !!searchToggle,
        searchInput: !!searchInput,
        toggleText: !!toggleText,
        submitSearchBtn: !!submitSearchBtn
      });
      
      var isSearchMode = false;
      var isFiltersOpen = false;
      
      // Переключение между фильтрами и поиском
      if (searchToggle && searchInput && toggleText) {
        searchToggle.addEventListener('click', function(e) {
          e.preventDefault();
          console.log('Клик по поиску, текущий режим:', isSearchMode);
          
          if (!isSearchMode) {
            // Включаем режим поиска
            isSearchMode = true;
            
            // Скрываем кнопку фильтров, показываем поле поиска
            filtersToggle.style.display = 'none';
            searchInput.style.display = 'block';
            if (submitSearchBtn) submitSearchBtn.style.display = 'flex';
            
            // Меняем иконку на крестик
            searchToggle.classList.add('active');
            searchToggle.innerHTML = '<i class="fa fa-times"></i>';
            
            setTimeout(function() {
              searchInput.focus();
            }, 100);
            
            // Закрываем панель фильтров если открыта
            if (isFiltersOpen && filtersPanel && filtersToggle) {
              filtersPanel.classList.remove('open');
              filtersToggle.classList.remove('active');
              isFiltersOpen = false;
            }
            
            console.log('Режим поиска включен');
          } else {
            // Выключаем режим поиска
            isSearchMode = false;
            
            // Показываем кнопку фильтров, скрываем поле поиска
            filtersToggle.style.display = 'flex';
            searchInput.style.display = 'none';
            if (submitSearchBtn) submitSearchBtn.style.display = 'none';
            
            // Возвращаем иконку поиска
            searchToggle.classList.remove('active');
            searchToggle.innerHTML = '<i class="fa fa-search"></i>';
            
            console.log('Режим поиска выключен');
          }
        });
      } else {
        console.log('Не все элементы поиска найдены');
      }
      
      // Переключение панели фильтров
      if (filtersToggle && filtersPanel) {
        filtersToggle.addEventListener('click', function() {
          console.log('Клик по фильтрам, режим поиска:', isSearchMode, 'панель открыта:', isFiltersOpen);
          
          if (isSearchMode) return; // Не работает в режиме поиска
          
          isFiltersOpen = !isFiltersOpen;
          
          if (isFiltersOpen) {
            filtersPanel.classList.add('open');
            filtersToggle.classList.add('active');
            console.log('Панель фильтров открыта');
          } else {
            filtersPanel.classList.remove('open');
            filtersToggle.classList.remove('active');
            console.log('Панель фильтров закрыта');
          }
        });
      } else {
        console.log('Элементы фильтров не найдены');
      }
      
      // Обработчик кнопки выполнения поиска
      if (submitSearchBtn) {
        submitSearchBtn.addEventListener('click', function(e) {
          e.preventDefault();
          console.log('Клик по кнопке поиска');
          if (searchInput && searchInput.form) {
            searchInput.form.submit();
          }
        });
      }
      
      // Отправка формы при Enter в поиске
      if (searchInput) {
        searchInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            console.log('Отправка формы поиска через Enter');
            this.form.submit();
          }
        });
      }
      
      console.log('Компактные фильтры инициализированы');
    })();
    
    // Управление бесконечным слайдером категорий
    (function() {
      var slider = document.getElementById('categoriesSlider');
      if (!slider) return;
      
      var isUserInteracting = false;
      var isDragging = false;
      var startX = 0;
      var currentTransform = 0;
      var startTransform = 0;
      var sliderWidth = 0;
      var sectionWidth = 0;
      var dragThreshold = 5; // Минимальное расстояние для считания драга
      var hasDragged = false;
      
      // Рассчитываем размеры для бесконечной прокрутки
      function calculateDimensions() {
        var allItems = slider.children;
        var itemsPerSection = allItems.length / 3; // У нас 3 копии
        sliderWidth = slider.scrollWidth;
        sectionWidth = sliderWidth / 3;
      }
      
      // Получаем текущее значение transform из CSS анимации
      function getCurrentTransform() {
        var style = window.getComputedStyle(slider);
        var matrix = style.transform;
        if (matrix === 'none') return 0;
        var values = matrix.match(/-?\d+\.?\d*/g);
        return values ? parseFloat(values[4]) || 0 : 0;
      }
      
      // Нормализуем позицию для бесконечной прокрутки (стартуем с -33.333%)
      function normalizePosition(x) {
        var startOffset = -sectionWidth / 3; // -33.333%
        
        // Если ушли слишком далеко влево от стартовой позиции
        if (x > startOffset) {
          x = x - sectionWidth;
        }
        // Если ушли слишком далеко вправо от стартовой позиции
        else if (x < startOffset - sectionWidth) {
          x = x + sectionWidth;
        }
        return x;
      }
      
      // Устанавливаем transform с нормализацией
      function setTransform(x, skipNormalization) {
        if (!skipNormalization) {
          x = normalizePosition(x);
        }
        slider.style.animation = 'none';
        slider.style.transform = 'translateX(' + x + 'px)';
        currentTransform = x;
      }
      
      // Возобновляем анимацию плавно
      function resumeAnimation() {
        // Нормализуем позицию без резких прыжков
        var normalizedPosition = normalizePosition(currentTransform);
        
        // Если позиция изменилась после нормализации, делаем плавный переход
        if (Math.abs(normalizedPosition - currentTransform) > 10) {
          slider.style.transition = 'transform 0.3s ease-out';
          slider.style.transform = 'translateX(' + normalizedPosition + 'px)';
          currentTransform = normalizedPosition;
          
          setTimeout(function() {
            slider.style.transition = '';
            slider.style.animation = '';
            slider.style.transform = '';
          }, 300);
        } else {
          // Просто возобновляем стандартную анимацию
          slider.style.animation = '';
          slider.style.transform = '';
        }
      }
      
      // Пауза анимации при наведении
      slider.addEventListener('mouseenter', function() {
        if (!isUserInteracting) {
          slider.style.animationPlayState = 'paused';
        }
      });
      
      slider.addEventListener('mouseleave', function() {
        if (!isUserInteracting) {
          slider.style.animationPlayState = 'running';
        }
      });
      
      // Ручное перетаскивание для десктопа
      slider.addEventListener('mousedown', function(e) {
        isDragging = true;
        isUserInteracting = true;
        hasDragged = false;
        slider.style.cursor = 'grabbing';
        currentTransform = getCurrentTransform();
        startTransform = currentTransform;
        startX = e.pageX;
        setTransform(currentTransform);
        
        // Предотвращаем клик только если это не категория
        if (!e.target.closest('.category-item')) {
          e.preventDefault();
        }
      });
      
      document.addEventListener('mousemove', function(e) {
        if (!isDragging) return;
        e.preventDefault();
        
        var deltaX = e.pageX - startX;
        
        // Проверяем, превышен ли порог для драга
        if (Math.abs(deltaX) > dragThreshold) {
          hasDragged = true;
          var newTransform = startTransform + deltaX;
          setTransform(newTransform, true); // Пропускаем нормализацию во время драга
        }
      });
      
      document.addEventListener('mouseup', function(e) {
        if (!isDragging) return;
        isDragging = false;
        slider.style.cursor = 'grab';
        
        // Если был драг, блокируем клик по ссылке
        if (hasDragged) {
          // Блокируем переход по ссылке если был драг
          var categoryItem = e.target.closest('.category-item');
          if (categoryItem) {
            e.preventDefault();
            e.stopPropagation();
          }
          
          setTimeout(function() {
            isUserInteracting = false;
            resumeAnimation();
            slider.style.animationPlayState = 'running';
          }, 2000);
        } else {
          // Если не было драга, сразу возобновляем (клик работает)
          isUserInteracting = false;
          slider.style.animationPlayState = 'running';
        }
      });
      
      // Поддержка тач-событий для мобильных
      slider.addEventListener('touchstart', function(e) {
        isUserInteracting = true;
        hasDragged = false;
        currentTransform = getCurrentTransform();
        startTransform = currentTransform;
        startX = e.touches[0].pageX;
        setTransform(currentTransform);
        
        // Предотвращаем скролл только если это не категория
        if (!e.target.closest('.category-item')) {
          e.preventDefault();
        }
      });
      
      slider.addEventListener('touchmove', function(e) {
        if (!isUserInteracting) return;
        e.preventDefault();
        
        var deltaX = e.touches[0].pageX - startX;
        
        // Проверяем, превышен ли порог для свайпа
        if (Math.abs(deltaX) > dragThreshold) {
          hasDragged = true;
          var newTransform = startTransform + deltaX;
          setTransform(newTransform, true); // Пропускаем нормализацию во время свайпа
        }
      });
      
      slider.addEventListener('touchend', function(e) {
        if (!isUserInteracting) return;
        
        // Если был свайп, блокируем клик по ссылке
        if (hasDragged) {
          // Блокируем переход по ссылке если был свайп
          var categoryItem = e.target.closest('.category-item');
          if (categoryItem) {
            e.preventDefault();
            e.stopPropagation();
          }
          
          setTimeout(function() {
            isUserInteracting = false;
            resumeAnimation();
            slider.style.animationPlayState = 'running';
          }, 2000);
        } else {
          // Если не было свайпа, сразу возобновляем (тап работает)
          isUserInteracting = false;
          slider.style.animationPlayState = 'running';
        }
      });
      
      // Дополнительная обработка кликов по категориям
      slider.addEventListener('click', function(e) {
        var categoryItem = e.target.closest('.category-item');
        if (categoryItem && !hasDragged) {
          // Если это клик по категории и не было драга, позволяем переход
          return true;
        } else if (hasDragged) {
          // Если был драг, блокируем клик
          e.preventDefault();
          e.stopPropagation();
        }
      });
      
      // Инициализация
      setTimeout(function() {
        calculateDimensions();
        
        // Рандомизация порядка категорий при загрузке
        var allItems = Array.from(slider.children);
        var itemsPerSection = allItems.length / 3;
        
        if (itemsPerSection > 0) {
          // Перемешиваем только первую секцию, остальные копируем
          var firstSection = allItems.slice(0, itemsPerSection);
          var shuffled = firstSection.slice();
          
          // Перемешиваем массив
          for (var i = shuffled.length - 1; i > 0; i--) {
            var j = Math.floor(Math.random() * (i + 1));
            var temp = shuffled[i];
            shuffled[i] = shuffled[j];
            shuffled[j] = temp;
          }
          
          // Применяем перемешанный порядок ко всем трем секциям
          for (var section = 0; section < 3; section++) {
            for (var i = 0; i < itemsPerSection; i++) {
              var originalIndex = section * itemsPerSection + i;
              var newItem = shuffled[i].cloneNode(true);
              slider.replaceChild(newItem, allItems[originalIndex]);
            }
          }
          
          // Пересчитываем размеры после перестановки
          setTimeout(calculateDimensions, 100);
        }
      }, 100);
    })();
  </script>
{% endblock %}
