{% extends "base.html" %}
{% load static humanize %}
{% load tour_filters %}

{% block after_header %}<div class="header-spacer" aria-hidden="true"></div>{% endblock %}
{% block title %}{{ tour.title }} — Экскурсии на Пхукете{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'styles/slide.css' %}">
  <link rel="stylesheet" href="{% static 'styles/tours.css' %}">
  <link rel="stylesheet" href="{% static 'styles/tour-detail.css' %}">
  <link rel="stylesheet" href="{% static 'styles/tour-sticky-cta.css' %}">
{% endblock %}
{% block body_class %}has-inner-hero{% endblock %}

{% block content %}

{# ===== SLIDE-HERO (inline) ===== #}
<section class="home slide slide--inner">
  <div class="home_slider_container">
    <div class="background_image" style="background-image:url({% if tour.cover %}{{ tour.cover.url }}{% else %}{% static 'images/home_slider.jpg' %}{% endif %})"></div>
    <div class="home_slider_content_container">
      <div class="hero hero--inner">
        <div class="container hero__grid">
          <div class="hero-left">
            <h1 class="hero-title">{{ tour.title }}</h1>
            <p class="hero-sub">{{ tour.location|default:"Пхукет" }}</p>
          </div>
          
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Блок категорий с автопрокруткой -->
<section class="tour-categories-slider">
  <div class="container">
    <div class="categories-slider-wrapper">
      <div class="categories-slider" id="categoriesSlider">
        {% for category in categories %}
          <a href="{% url 'tours:by_category' category.slug %}" class="category-item">
            <span class="category-name">{{ category.name }}</span>
            <span class="category-count">({{ category.items }})</span>
          </a>
        {% endfor %}
        <!-- Дублируем категории для бесконечной прокрутки -->
        {% for category in categories %}
          <a href="{% url 'tours:by_category' category.slug %}" class="category-item">
            <span class="category-name">{{ category.name }}</span>
            <span class="category-count">({{ category.items }})</span>
          </a>
        {% endfor %}
        <!-- Третья копия для более плавного кольца -->
        {% for category in categories %}
          <a href="{% url 'tours:by_category' category.slug %}" class="category-item">
            <span class="category-name">{{ category.name }}</span>
            <span class="category-count">({{ category.items }})</span>
          </a>
        {% endfor %}
      </div>
    </div>
  </div>
</section>

  <section class="t-detail">
    <div class="container" style="padding-top: 60px;">
      <!-- Якорь для определения начала контента -->
      <div id="contentStart" class="d-lg-none" style="height: 1px; margin-bottom: -1px;"></div>
      <div id="tCtaAnchor" class="d-lg-none"></div>
      <div class="row">

        <!-- Основная колонка -->
        <div class="col-lg-8 col-xl-9">
          
          <!-- ФИКСИРОВАННЫЙ КОНТЕНТ: Основная информация о туре -->
          <div class="t-fixed-content d-lg-none" id="fixedContent">
            
            <!-- Короткое описание (сразу под слайдом на мобиле) -->
            {% if tour.short_desc %}
              <div class="t-short-desc mb-3">
                <p class="lead">{{ tour.short_desc }}</p>
              </div>
            {% endif %}

            <!-- Короткие преимущества / highlights -->
            <div class="t-highlights mb-3">
              <span class="t-chip"><i class="fa fa-bus"></i> Трансфер включён</span>
              <span class="t-chip"><i class="fa fa-shield"></i> Страховка</span>
              {% if tour.duration %}
                <span class="t-chip"><i class="fa fa-clock-o"></i> {{ tour.duration }}</span>
              {% endif %}
              <span class="t-chip"><i class="fa fa-users"></i> Малые группы</span>
            </div>
            
          </div>
          <!-- КОНЕЦ ФИКСИРОВАННОГО КОНТЕНТА -->

          <!-- CTA bar: positioned after highlights, before detailed info -->
          <div class="t-cta-bar d-lg-none" id="tCtaBar">
            <div class="t-top-cta__price">
              {% if tour.price_old_adult and tour.price_old_adult > tour.price_adult %}
                <s class="t-price__old">{{ tour.price_old_adult|floatformat:0|intcomma }}฿</s>
              {% endif %}
              <strong class="t-price__new">{{ tour.price_adult|floatformat:0|intcomma }}฿</strong>
            </div>
            <button class="t-top-cta__btn open-lead-modal"
                    data-cta="CTA — Tour Detail"
                    data-related_type="tour" data-related_id="{{ tour.id }}"
                    type="button">Оставить заявку</button>
          </div>

          <!-- ДОПОЛНИТЕЛЬНЫЙ КОНТЕНТ -->
          <div class="t-additional-content d-lg-none">
            
            <!-- Основная информация о туре -->
            <div class="t-info-grid mb-4">
              <div class="row g-3">
                {% if tour.duration %}
                  <div class="col-md-6">
                    <div class="t-info-item">
                      <i class="fa fa-clock-o"></i>
                      <div>
                        <strong>Длительность</strong>
                        <span>{{ tour.duration }}</span>
                      </div>
                    </div>
                  </div>
                {% endif %}
                {% if tour.location %}
                  <div class="col-md-6">
                    <div class="t-info-item">
                      <i class="fa fa-map-marker"></i>
                      <div>
                        <strong>Локация</strong>
                        <span>{{ tour.location }}</span>
                      </div>
                    </div>
                  </div>
                {% endif %}
                {% if tour.rating %}
                  <div class="col-md-6">
                    <div class="t-info-item">
                      <i class="fa fa-star"></i>
                      <div>
                        <strong>Рейтинг</strong>
                        <span>{{ tour.rating }}/5 ({{ tour.reviews_count }} отзывов)</span>
                      </div>
                    </div>
                  </div>
                {% endif %}
                {% if tour.categories.all %}
                  <div class="col-md-6">
                    <div class="t-info-item">
                      <i class="fa fa-tags"></i>
                      <div>
                        <strong>Категории</strong>
                        <span>
                          {% for cat in tour.categories.all %}
                            <a href="{% url 'tours:by_category' slug=cat.slug %}">{{ cat.name }}</a>{% if not forloop.last %}, {% endif %}
                          {% endfor %}
                        </span>
                      </div>
                    </div>
                  </div>
                {% endif %}
              </div>
            </div>
            
          </div>
          <!-- КОНЕЦ ДОПОЛНИТЕЛЬНОГО КОНТЕНТА -->


          <!-- ОСТАЛЬНОЙ КОНТЕНТ -->
          
          <!-- Галерея изображений -->
          {% if tour.images.all %}
            <div class="t-gallery owl-carousel owl-theme mb-4">
              {% for img in tour.images.all %}
                <div class="item">
                  <img src="{{ img.image.url }}" alt="{{ img.caption|default:tour.title }} — фото {{ forloop.counter }}" loading="lazy">
                </div>
              {% endfor %}
            </div>
          {% endif %}

          <!-- YouTube видео -->
          {% if tour.youtube_url and tour.youtube_url|youtube_embed %}
            <div class="t-video mb-4">
              <div class="video-container">
                <iframe src="{{ tour.youtube_url|youtube_embed }}" 
                        frameborder="0" 
                        allowfullscreen
                        title="Видео тура: {{ tour.title }}">
                </iframe>
              </div>
            </div>
          {% endif %}

          <!-- Полное описание -->
          {% if tour.description %}
            <div class="t-prose mb-4">
              <h3>Описание тура</h3>
              {{ tour.description|safe }}
            </div>
          {% endif %}

          <!-- Что включено/не включено -->
          {% if tour.included or tour.excluded %}
            <div class="t-included-excluded mb-4">
              <div class="row g-3">
                {% if tour.included %}
                  <div class="col-md-6">
                    <div class="t-box t-box--included">
                      <div class="t-box__title">
                        <i class="fa fa-check-circle"></i> 
                        Что включено
                      </div>
                      <div class="t-box__content">
                        {{ tour.included|linebreaks }}
                      </div>
                    </div>
                  </div>
                {% endif %}
                {% if tour.excluded %}
                  <div class="col-md-6">
                    <div class="t-box t-box--excluded">
                      <div class="t-box__title">
                        <i class="fa fa-times-circle"></i> 
                        Не включено
                      </div>
                      <div class="t-box__content">
                        {{ tour.excluded|linebreaks }}
                      </div>
                    </div>
                  </div>
                {% endif %}
              </div>
            </div>
          {% endif %}

          {# Индивидуальный график: используем описание тура, без шаблонного таймлайна #}

          <!-- Важная информация -->
          {% if tour.info %}
            <div class="t-important-info mb-4">
              <h3>Важная информация</h3>
              <div class="t-info-content">
                {{ tour.info|linebreaks }}
              </div>
            </div>
          {% else %}
            <div class="t-important-info mb-4">
              <h3>Важная информация</h3>
              <div class="t-info-cards">
                <div class="t-info-card">
                  <i class="fa fa-calendar"></i>
                  <div>
                    <h4>Бронирование</h4>
                    <p>Бронирование необходимо за 24 часа до начала тура</p>
                  </div>
                </div>
                <div class="t-info-card">
                  <i class="fa fa-users"></i>
                  <div>
                    <h4>Группа</h4>
                    <p>Минимум 2 человека, максимум 15 человек в группе</p>
                  </div>
                </div>
                <div class="t-info-card">
                  <i class="fa fa-umbrella"></i>
                  <div>
                    <h4>Погода</h4>
                    <p>Тур проводится в любую погоду, при необходимости предоставляются дождевики</p>
                  </div>
                </div>
                <div class="t-info-card">
                  <i class="fa fa-child"></i>
                  <div>
                    <h4>Дети</h4>
                    <p>Дети до 3 лет бесплатно, с 3 до 12 лет детский тариф</p>
                  </div>
                </div>
              </div>
            </div>
          {% endif %}

          <!-- Теги -->
          {% if tour.tags.all %}
            <div class="t-tags mb-4">
              <h4>Теги</h4>
              <div class="t-tags-list">
                {% for tg in tour.tags.all %}
                  <a class="t-tag" href="{% url 'tours:by_tag' slug=tg.slug %}">#{{ tg.name }}</a>
                {% endfor %}
              </div>
            </div>
          {% endif %}

          {% if related_tours %}
            <div class="t-related mt-5">
              <div class="t-related__title">Похожие туры</div>
              <div class="t-related__scroller" role="region" aria-label="Похожие туры">
                {% for r in related_tours %}
                  <article class="t-card t-card--hscroll" style="cursor:pointer;" onclick="location.href='{{ r.get_absolute_url }}'">
                    <div class="t-card__cover">
                      {% if r.cover %}
                        <img class="t-card__img" src="{{ r.cover.url }}" alt="{{ r.title }}" loading="lazy">
                      {% else %}
                        <img class="t-card__img" src="{% static 'images/travello.jpg' %}" alt="{{ r.title }}" loading="lazy">
                      {% endif %}
                      {% if r.has_discount %}<span class="badge badge--disc">Скидка</span>{% endif %}
                      {% if r.is_popular %}<span class="badge badge--hit">Хит</span>{% endif %}
                    </div>
                    <div class="t-card__body">
                      <div class="t-card__header">
                        <h3 class="t-card__title">{{ r.title }}</h3>
                        <div class="t-card__meta">
                          {% if r.duration %}<span class="t-meta-item"><i class="fa fa-clock-o"></i> {{ r.duration }}</span>{% endif %}
                          {% if r.location %}<span class="t-meta-item"><i class="fa fa-map-marker"></i> {{ r.location }}</span>{% endif %}
                        </div>
                      </div>

                      <div class="t-card__price-section">
                        <div class="t-card__price-main">
                          <div class="t-price-group">
                            <span class="t-price-label">Взрослые</span>
                            <div class="t-price">
                              {% if r.price_old_adult and r.price_old_adult > r.price_adult %}
                                <s class="t-price__old">{{ r.price_old_adult|floatformat:0|intcomma }}฿</s>
                              {% endif %}
                              <strong class="t-price__new">{{ r.price_adult|floatformat:0|intcomma }}฿</strong>
                            </div>
                          </div>
                          {% if r.price_child %}
                          <div class="t-price-group">
                            <span class="t-price-label">Дети</span>
                            <div class="t-price">
                              {% if r.price_old_child and r.price_old_child > r.price_child %}
                                <s class="t-price__old">{{ r.price_old_child|floatformat:0|intcomma }}฿</s>
                              {% endif %}
                              <strong class="t-price__new">{{ r.price_child|floatformat:0|intcomma }}฿</strong>
                            </div>
                          </div>
                          {% endif %}
                        </div>
                      </div>

                      <div class="t-card__footer">
                        <div class="t-rating">
                          <i class="fa fa-star"></i>
                          <span class="t-rating-value">{{ r.rating|default:"4.9" }}</span>
                          {% if r.reviews_count %}<span class="t-reviews-count">({{ r.reviews_count }})</span>{% endif %}
                        </div>
                        <button class="order_btn open-lead-modal"
                                data-cta="Related — {{ r.title }}"
                                data-related_type="tour" data-related_id="{{ r.id }}">Заказать</button>
                      </div>
                    </div>
                  </article>
                {% endfor %}
              </div>
            </div>
          {% endif %}
        </div>

        <!-- Сайдбар -->
        <aside class="col-lg-4 col-xl-3 t-aside">
          
          <!-- Блок бронирования -->
          <div class="t-widget t-widget--sticky">
            <div class="t-pricebox">
              <div class="t-pricebox__header">
                <h4>Забронировать тур</h4>
                {% if tour.is_popular %}<span class="badge badge--hit">Хит</span>{% endif %}
                {% if tour.has_discount %}<span class="badge badge--disc">Скидка</span>{% endif %}
              </div>
              
              <div class="t-pricebox__prices">
                <div class="t-pricebox__row">
                  <span>Взрослые</span>
                  <div class="t-price">
                    {% if tour.price_old_adult and tour.price_old_adult > tour.price_adult %}
                      <s class="t-price__old">{{ tour.price_old_adult|floatformat:0|intcomma }}฿</s>
                    {% endif %}
                    <strong class="t-price__new">{{ tour.price_adult|floatformat:0|intcomma }}฿</strong>
                  </div>
                </div>
                {% if tour.price_child %}
                  <div class="t-pricebox__row">
                    <span>Дети (3-12 лет)</span>
                    <div class="t-price">
                      {% if tour.price_old_child and tour.price_old_child > tour.price_child %}
                        <s class="t-price__old">{{ tour.price_old_child|floatformat:0|intcomma }}฿</s>
                      {% endif %}
                      <strong class="t-price__new">{{ tour.price_child|floatformat:0|intcomma }}฿</strong>
                    </div>
                  </div>
                {% endif %}
                {% if tour.price_extra %}
                  <div class="t-pricebox__row">
                    <span>Доп. услуги</span>
                    <div class="t-price">
                      <strong class="t-price__new">{{ tour.price_extra|floatformat:0|intcomma }}฿</strong>
                    </div>
                  </div>
                {% endif %}
              </div>
              
              <div class="t-pricebox__features">
                <div class="t-feature">
                  <i class="fa fa-check"></i>
                  <span>Бесплатная отмена за 24 часа</span>
                </div>
                <div class="t-feature">
                  <i class="fa fa-check"></i>
                  <span>Мгновенное подтверждение</span>
                </div>
                <div class="t-feature">
                  <i class="fa fa-check"></i>
                  <span>Мобильный билет</span>
                </div>
              </div>
              
              <button class="order_btn w-100 open-lead-modal"
                      data-cta="Tour Detail — Sidebar"
                      data-related_type="tour" data-related_id="{{ tour.id }}">
                <i class="fa fa-calendar"></i>
                Забронировать сейчас
              </button>
              
              <div class="t-pricebox__note">
                <small>Цены указаны за одного человека. Дети до 3 лет бесплатно.</small>
              </div>
            </div>
          </div>

          <!-- Информация о туре -->
          <div class="t-aside__box">
            <div class="t-aside__title">
              <i class="fa fa-info-circle"></i>
              Информация о туре
            </div>
            <div class="t-aside__content">
              {% if tour.duration %}
                <div class="t-aside__item">
                  <i class="fa fa-clock-o"></i>
                  <div>
                    <strong>Длительность</strong>
                    <span>{{ tour.duration }}</span>
                  </div>
                </div>
              {% endif %}
              {% if tour.location %}
                <div class="t-aside__item">
                  <i class="fa fa-map-marker"></i>
                  <div>
                    <strong>Локация</strong>
                    <span>{{ tour.location }}</span>
                  </div>
                </div>
              {% endif %}
              {% if tour.rating %}
                <div class="t-aside__item">
                  <i class="fa fa-star"></i>
                  <div>
                    <strong>Рейтинг</strong>
                    <span>{{ tour.rating }}/5 ({{ tour.reviews_count }} отзывов)</span>
                  </div>
                </div>
              {% endif %}
            </div>
          </div>

          <!-- Категории -->
          {% if tour.categories.all %}
            <div class="t-aside__box">
              <div class="t-aside__title">
                <i class="fa fa-tags"></i>
                Категории
              </div>
              <div class="t-aside__content">
                {% for cat in tour.categories.all %}
                  <a href="{% url 'tours:by_category' slug=cat.slug %}" class="t-category-link">
                    {{ cat.name }}
                  </a>
                {% endfor %}
              </div>
            </div>
          {% endif %}

          <!-- Контакты -->
          <div class="t-aside__box">
            <div class="t-aside__title">
              <i class="fa fa-phone"></i>
              Нужна помощь?
            </div>
            <div class="t-aside__content">
              <div class="t-contact-info">
                <div class="t-contact-item">
                  <i class="fa fa-phone"></i>
                  <a href="tel:{{ site_settings.phone|default:'+66812345678' }}">{{ site_settings.phone|default:'+66 81 234 5678' }}</a>
                </div>
                <div class="t-contact-item">
                  <i class="fa fa-whatsapp"></i>
                  <a href="{{ site_settings.whatsapp|default:'https://wa.me/66812345678' }}" target="_blank">WhatsApp</a>
                </div>
                <div class="t-contact-item">
                  <i class="fa fa-envelope"></i>
                  <a href="mailto:{{ site_settings.email|default:'info@thaidreamphuket.com' }}">{{ site_settings.email|default:'info@thaidreamphuket.com' }}</a>
                </div>
              </div>
            </div>
          </div>

          <!-- Поделиться -->
          <div class="t-aside__box">
            <div class="t-aside__title">
              <i class="fa fa-share-alt"></i>
              Поделиться
            </div>
            <div class="t-aside__content">
              <div class="t-share-buttons">
                <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri }}" 
                   target="_blank" class="t-share-btn t-share-btn--fb">
                  <i class="fa fa-facebook"></i>
                </a>
                <a href="https://twitter.com/intent/tweet?url={{ request.build_absolute_uri }}&text={{ tour.title }}" 
                   target="_blank" class="t-share-btn t-share-btn--tw">
                  <i class="fa fa-twitter"></i>
                </a>
                <a href="https://t.me/share/url?url={{ request.build_absolute_uri }}&text={{ tour.title }}" 
                   target="_blank" class="t-share-btn t-share-btn--tg">
                  <i class="fa fa-telegram"></i>
                </a>
                <a href="https://vk.com/share.php?url={{ request.build_absolute_uri }}" 
                   target="_blank" class="t-share-btn t-share-btn--vk">
                  <i class="fa fa-vk"></i>
                </a>
              </div>
            </div>
          </div>
        </aside>

      </div>
    </div>
  </section>

{% endblock %}

{% block extra_js %}
  <script src="{% static 'js/tour-detail.js' %}"></script>
  <script>
    (function() {
      var $ = window.jQuery || null;
      if (!$ || !$.fn || !$.fn.owlCarousel) return;
      var gal = document.querySelector('.t-gallery');
      if (!gal) return;
      $('.t-gallery').owlCarousel({
        items: 1, loop: true, dots: true, nav: false, autoplay: true, autoplayTimeout: 5000
      });
    })();
    
    // Управление бесконечным слайдером категорий
    (function() {
      var slider = document.getElementById('categoriesSlider');
      if (!slider) return;
      
      var isUserInteracting = false;
      var isDragging = false;
      var startX = 0;
      var currentTransform = 0;
      var startTransform = 0;
      var sliderWidth = 0;
      var sectionWidth = 0;
      var dragThreshold = 5; // Минимальное расстояние для считания драга
      var hasDragged = false;
      
      // Рассчитываем размеры для бесконечной прокрутки
      function calculateDimensions() {
        var allItems = slider.children;
        var itemsPerSection = allItems.length / 3; // У нас 3 копии
        sliderWidth = slider.scrollWidth;
        sectionWidth = sliderWidth / 3;
      }
      
      // Получаем текущее значение transform из CSS анимации
      function getCurrentTransform() {
        var style = window.getComputedStyle(slider);
        var matrix = style.transform;
        if (matrix === 'none') return 0;
        var values = matrix.match(/-?\d+\.?\d*/g);
        return values ? parseFloat(values[4]) || 0 : 0;
      }
      
      // Нормализуем позицию для бесконечной прокрутки (стартуем с -33.333%)
      function normalizePosition(x) {
        var startOffset = -sectionWidth / 3; // -33.333%
        
        // Если ушли слишком далеко влево от стартовой позиции
        if (x > startOffset) {
          x = x - sectionWidth;
        }
        // Если ушли слишком далеко вправо от стартовой позиции
        else if (x < startOffset - sectionWidth) {
          x = x + sectionWidth;
        }
        return x;
      }
      
      // Устанавливаем transform с нормализацией
      function setTransform(x, skipNormalization) {
        if (!skipNormalization) {
          x = normalizePosition(x);
        }
        slider.style.animation = 'none';
        slider.style.transform = 'translateX(' + x + 'px)';
        currentTransform = x;
      }
      
      // Возобновляем анимацию плавно с текущей позиции
      function resumeAnimation() {
        // Получаем текущую позицию
        var currentPos = currentTransform;
        
        // Нормализуем только если вышли за границы
        var normalizedPos = normalizePosition(currentPos);
        
        // Если нужна нормализация, делаем плавный переход
        if (Math.abs(normalizedPos - currentPos) > 10) {
          slider.style.transition = 'transform 0.5s ease-out';
          slider.style.transform = 'translateX(' + normalizedPos + 'px)';
          
          setTimeout(function() {
            slider.style.transition = '';
            // После нормализации продолжаем анимацию с новой позиции
            continueAnimationFrom(normalizedPos);
          }, 500);
        } else {
          // Продолжаем анимацию с текущей позиции
          continueAnimationFrom(currentPos);
        }
      }
      
      // Продолжаем анимацию с заданной позиции
      function continueAnimationFrom(fromPos) {
        // Рассчитываем следующую целевую позицию
        var targetPos = fromPos - sectionWidth;
        
        // Рассчитываем расстояние и время
        var distance = Math.abs(targetPos - fromPos);
        var fullDistance = sectionWidth;
        var fullDuration = 90; // секунды
        var remainingDuration = (distance / fullDistance) * fullDuration;
        
        // Создаем уникальное имя анимации
        var animationName = 'continueSlide' + Date.now();
        
        // Создаем keyframes для продолжения
        var keyframes = 
          '@keyframes ' + animationName + ' {' +
            '0% { transform: translateX(' + fromPos + 'px); }' +
            '100% { transform: translateX(' + targetPos + 'px); }' +
          '}';
        
        // Добавляем стили
        var style = document.createElement('style');
        style.textContent = keyframes;
        document.head.appendChild(style);
        
        // Применяем анимацию
        slider.style.animation = animationName + ' ' + remainingDuration + 's linear infinite';
        
        // Очищаем временные стили
        setTimeout(function() {
          if (style.parentNode) {
            style.parentNode.removeChild(style);
          }
          // Возвращаемся к стандартной анимации
          slider.style.animation = '';
          slider.style.transform = '';
        }, remainingDuration * 1000);
      }
      
      // Пауза анимации при наведении
      slider.addEventListener('mouseenter', function() {
        if (!isUserInteracting) {
          slider.style.animationPlayState = 'paused';
        }
      });
      
      slider.addEventListener('mouseleave', function() {
        if (!isUserInteracting) {
          slider.style.animationPlayState = 'running';
        }
      });
      
      // Ручное перетаскивание для десктопа
      slider.addEventListener('mousedown', function(e) {
        isDragging = true;
        isUserInteracting = true;
        hasDragged = false;
        slider.style.cursor = 'grabbing';
        currentTransform = getCurrentTransform();
        startTransform = currentTransform;
        startX = e.pageX;
        setTransform(currentTransform);
        
        // Предотвращаем клик только если это не категория
        if (!e.target.closest('.category-item')) {
          e.preventDefault();
        }
      });
      
      document.addEventListener('mousemove', function(e) {
        if (!isDragging) return;
        e.preventDefault();
        
        var deltaX = e.pageX - startX;
        
        // Проверяем, превышен ли порог для драга
        if (Math.abs(deltaX) > dragThreshold) {
          hasDragged = true;
          var newTransform = startTransform + deltaX;
          setTransform(newTransform, true); // Пропускаем нормализацию во время драга
        }
      });
      
      document.addEventListener('mouseup', function(e) {
        if (!isDragging) return;
        isDragging = false;
        slider.style.cursor = 'grab';
        
        // Если был драг, блокируем клик по ссылке
        if (hasDragged) {
          // Блокируем переход по ссылке если был драг
          var categoryItem = e.target.closest('.category-item');
          if (categoryItem) {
            e.preventDefault();
            e.stopPropagation();
          }
          
          setTimeout(function() {
            isUserInteracting = false;
            resumeAnimation();
            slider.style.animationPlayState = 'running';
          }, 2000);
        } else {
          // Если не было драга, сразу возобновляем (клик работает)
          isUserInteracting = false;
          slider.style.animationPlayState = 'running';
        }
      });
      
      // Поддержка тач-событий для мобильных
      slider.addEventListener('touchstart', function(e) {
        isUserInteracting = true;
        hasDragged = false;
        currentTransform = getCurrentTransform();
        startTransform = currentTransform;
        startX = e.touches[0].pageX;
        setTransform(currentTransform);
        
        // Предотвращаем скролл только если это не категория
        if (!e.target.closest('.category-item')) {
          e.preventDefault();
        }
      });
      
      slider.addEventListener('touchmove', function(e) {
        if (!isUserInteracting) return;
        e.preventDefault();
        
        var deltaX = e.touches[0].pageX - startX;
        
        // Проверяем, превышен ли порог для свайпа
        if (Math.abs(deltaX) > dragThreshold) {
          hasDragged = true;
          var newTransform = startTransform + deltaX;
          setTransform(newTransform, true); // Пропускаем нормализацию во время свайпа
        }
      });
      
      slider.addEventListener('touchend', function(e) {
        if (!isUserInteracting) return;
        
        // Если был свайп, блокируем клик по ссылке
        if (hasDragged) {
          // Блокируем переход по ссылке если был свайп
          var categoryItem = e.target.closest('.category-item');
          if (categoryItem) {
            e.preventDefault();
            e.stopPropagation();
          }
          
          setTimeout(function() {
            isUserInteracting = false;
            resumeAnimation();
            slider.style.animationPlayState = 'running';
          }, 2000);
        } else {
          // Если не было свайпа, сразу возобновляем (тап работает)
          isUserInteracting = false;
          slider.style.animationPlayState = 'running';
        }
      });
      
      // Дополнительная обработка кликов по категориям
      slider.addEventListener('click', function(e) {
        var categoryItem = e.target.closest('.category-item');
        if (categoryItem && !hasDragged) {
          // Если это клик по категории и не было драга, позволяем переход
          return true;
        } else if (hasDragged) {
          // Если был драг, блокируем клик
          e.preventDefault();
          e.stopPropagation();
        }
      });
      
      // Инициализация
      setTimeout(function() {
        calculateDimensions();
        
        // Рандомизация порядка категорий при загрузке
        var allItems = Array.from(slider.children);
        var itemsPerSection = allItems.length / 3;
        
        if (itemsPerSection > 0) {
          // Перемешиваем только первую секцию, остальные копируем
          var firstSection = allItems.slice(0, itemsPerSection);
          var shuffled = firstSection.slice();
          
          // Перемешиваем массив
          for (var i = shuffled.length - 1; i > 0; i--) {
            var j = Math.floor(Math.random() * (i + 1));
            var temp = shuffled[i];
            shuffled[i] = shuffled[j];
            shuffled[j] = temp;
          }
          
          // Применяем перемешанный порядок ко всем трем секциям
          for (var section = 0; section < 3; section++) {
            for (var i = 0; i < itemsPerSection; i++) {
              var originalIndex = section * itemsPerSection + i;
              var newItem = shuffled[i].cloneNode(true);
              slider.replaceChild(newItem, allItems[originalIndex]);
            }
          }
          
          // Пересчитываем размеры после перестановки
          setTimeout(calculateDimensions, 100);
        }
      }, 100);
    })();
  </script>
{% endblock %}
